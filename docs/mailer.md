# Mailer

> Our Mailer use the MailerInterface from Symfony to do the sending and an EmailProvider based on email configuration
> to verify that the email we want to send is actually define on the configuration.
> Our email model extend the TemplatedEmail to ease handling html/text template and benefit from his parent Email methods.

## How to add the autogenerated email documentation

Add the route to your application’s routing file:

```yaml
# config/routes/sonata_admin.yaml
smart_sonata:
    resource: "@SmartSonataBundle/config/routing.yaml"
    host:     "admin.%domain%"
```

Update you sonata_admin config package:

```yaml
sonata_admin:
    ...
    dashboard:
        groups:
            documentations:
                label: dashboard.label_documentations
                label_catalogue: admin
                icon: '<i class="fa fa-book"></i>'
                items:
                    - route: smart_sonata_documentation_email
                      label: dashboard.label_documentation_email
```

And voilà !

## How to register an email in the EmailProvider

Define your email code as shown on the [configuration reference](configuration.md)

Then create your email template based on the path of your email code.

For example if your email code is `admin.security.forgot_password` then you must create a template on theses path :

```yaml
# if you are not using the `translate_email` option, then you path must look like this:
/tempaltes/email/admin/security/forgot_password.html.twig

# if you are using the `translate_email` option then create as many template as your project handles locales like this:
/tempaltes/fr/email/admin/security/forgot_password.html.twig
/tempaltes/en/email/admin/security/forgot_password.html.twig
```

Last step is to create the appropriate translation for your email code for the **subject** and **documentation**.

```xml
<!-- /translations/email.en with our `admin.security.forgot_password` example you must add this translation -->
<trans-unit id="admin.security.account_creation.subject">
    <source>admin.security.account_creation.subject</source>
    <target>To complete your account, please initialize your password</target>
</trans-unit>
<trans-unit id="admin.security.account_creation.doc_title">
    <source>admin.security.account_creation.doc_title</source>
    <target>Finish Backoffice account creation</target>
</trans-unit>
```

## How to send an email

- Inject the BaseMailer service on your controller or service.
- Call the newEmail method to instansiate a TemplatedEmail
- (Adjust the TemplatedEmail if you need to)
- Send the email to your recipient

Example code:

```php
use Smart\SonataBundle\Mailer\BaseMailer;
// ...

    public function myAction(BaseMailer $mailer): Response
    {
        // your logic

        $email = $mailer->newEmail('group.your.email.code', [
            'some_context_variable' => 'some_value',
        ]);
        // if you need extra behavior on your email just use the appropriate TemplatedEmail method
        // for example: $email->attach($reportPdf, "your-awesome-report.pdf", 'application/json')
        $mailer->send($email, 'recipient@example.com');

        // ...
    }
```

If you need to centralize custom logic to set the recipient for the email (like a CommercialMailer for example that
get his email from some external configuration), just extend the BaseMailer and override the `setRecipientToEmail` method.
