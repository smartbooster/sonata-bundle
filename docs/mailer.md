# Mailer

> Our Mailer use the MailerInterface from Symfony to do the sending and an EmailProvider based on email configuration
> to verify that the email we want to send is actually define on the configuration.
> Our email model extend the TemplatedEmail to ease handling html/text template and benefit from his parent Email methods.

## How to add the autogenerated email documentation

Enable the bundle route on your `config/routes.yaml` file:
```yaml
_smart_sonata:
    resource: .
    type: smart_sonata
    host: "admin.%domain%"
```

Update you sonata_admin config package:
```yaml
sonata_admin:
    # ...
    dashboard:
        groups:
            documentations:
                label: dashboard.label_documentations
                label_catalogue: admin
                icon: '<i class="fa fa-book"></i>'
                items:
                    - route: smart_sonata_documentation_email
                      label: dashboard.label_documentation_email
```

And voil√† !

## How to register an email in the EmailProvider

Define your email code as shown on the [configuration reference](configuration.md)

Then create your email template based on the path of your email code.  
For example if your email code is `admin.security.forgot_password` then you must create a template on theses path :

```yaml
# if you are not using the `translate_email` option, then you path must look like this:
/tempaltes/email/admin/security/forgot_password.html.twig

# if you are using the `translate_email` option then create as many template as your project handles locales like this:
/tempaltes/fr/email/admin/security/forgot_password.html.twig
/tempaltes/en/email/admin/security/forgot_password.html.twig
```

Create the appropriate translation for your email code for the **subject** and **documentation**.

```xml
<!-- /translations/email.en with our `admin.security.forgot_password` example you must add this translation -->
<trans-unit id="admin.security.account_creation.subject">
    <source>admin.security.account_creation.subject</source>
    <target>To complete your account, please initialize your password</target>
</trans-unit>
<trans-unit id="admin.security.account_creation.doc_title">
    <source>admin.security.account_creation.doc_title</source>
    <target>Finish Backoffice account creation</target>
</trans-unit>
```

Finaly to keep track on the documentation email who is the recipient, and what trigger the email sending, you can add the following on your template :

```twig
{% block documentation_help %}
    <p><strong>{{ 'email.recipient'|trans }}</strong> : Foo</p>
    <p><strong>{{ 'email.trigger'|trans }}</strong> : The email is sent when ...</p>
{% endblock %}
```

_The `templates/admin/documentation/email.html.twig` will render the documentation_help block_

## How to send an email

- Inject the BaseMailer service on your controller or service.
- Call the newEmail method to instansiate a TemplatedEmail
- (Adjust the TemplatedEmail if you need to)
- Send the email to your recipient

Example code:

```php
use Smart\SonataBundle\Mailer\BaseMailer;
// ...

    public function myAction(BaseMailer $mailer): Response
    {
        // your logic

        $email = $mailer->newEmail('group.your.email.code', [
            'some_context_variable' => 'some_value',
        ]);
        // if you need extra behavior on your email just use the appropriate TemplatedEmail method
        // for example: $email->attach($reportPdf, "your-awesome-report.pdf", 'application/json')
        $mailer->send($email, 'recipient@example.com');

        // ...
    }
```

### Send email to MailableInterface

The core-bundle provide a `MailableInterface` which is a valid recipient for the `BaseMailer::send` method.  
This allow you to pass an entity/object to the send method which automatically set the to, cc and Bcc.

```php
/** @var MailableInterface */
$mailer->send($email, $user);
```

## How to extend the BaseMailer to add custom business logic

In some case, you might want to extend our Mailer to add custom logic when the email is sent, for example :
- Log the event of the email being sent in a dedicated ActionLog entity (specific to the project which also contains other actions) for statistic purpose.

If that the case here is a boilerplate of what you need to do :

```php
<?php

namespace App\Mailer;

use Smart\SonataBundle\Mailer\BaseMailer;
use Smart\SonataBundle\Mailer\TemplatedEmail;
use Symfony\Component\DependencyInjection\Attribute\Autowire;
use Symfony\Contracts\Service\Attribute\Required;

class CustomMailer extends BaseMailer
{
    // Inject custom service if you need to
    private MyCustomService $service;
    #[Required]
    public function setMyCustomService(MyCustomService $service): void
    {
        $this->service = $service;
    }

    public function send(TemplatedEmail $email, mixed $recipient = null): void
    {
        parent::send($email, $recipient);
        
        $this->service->customBusinessLogic();
        // ...
    }

    /** 
     * Known issue that the sender address isn't set on custom mailer like BaseMailer is by the SmartSonataExtension.
     * So we fix it by autowire the sender with param fetch with the Autowire attribute which is cleaner to do it via the __construct 
     */
    #[Required]
    public function autowireSender(#[Autowire('%app.mail_from%')] string $address): void
    {
        $this->setSender(['address' => $address]);
    }
}
```

As mention on the example above, inject custom service using the `#[Required]` instead of the `__construct` method.  
This technique helps you with less upgrade maintaining in case the `__construct` method of the parent BaseMailer evolves.
